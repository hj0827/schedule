import{_ as E}from"./CalendarEdit.vue_vue_type_script_setup_true_lang-BwZZnM8v.js";import{g as O,u as k}from"./schedule-eMs4Cjr4.js";import{i as F,a as I,b as B,F as J}from"./index-DlKmcoY9.js";import{E as T}from"./BaseEnum-DZksv6ke.js";import{d as R,r as h,a as x,o as G,c as V,e as j,f as b,w as q,u as z,F as U,b as a,A as y,h as l,t as u,_ as K}from"./index-DFxeWJFZ.js";import"./useDialog-Dl2BjXS6.js";import"./useTable-C-JI8HsX.js";import"./useInstance-MikN16Nm.js";import"./index-2NxJnuEc.js";const Q={class:"text-ellipsis"},X=R({__name:"CalendarList",setup(Z,{expose:D}){const v=h(),i=h(),M=()=>{i.value.getApi().prev()},A=()=>{i.value.getApi().next()},P=()=>{i.value.getApi().today(),i.value.getApi().getDate()},N=()=>{i.value.getApi().prev()},w=()=>{i.value.getApi().next()},Y=()=>{i.value.getApi().today(),i.value.getApi().getDate},_=t=>{console.log(t);const s=a(t.date),n={dateTime:s.format("YYYY-MM-DD"),beginTime:s.format("HH:mm"),duration:60};v.value.editCalender(T.ADD,n)},$=t=>{console.log("editClick 数据:",JSON.stringify(t.event.extendedProps,null,2)),v.value.editCalender(T.EDIT,t.event.extendedProps)},p=x({id:"",beginTime:"",endTime:"",dateTime:"",duration:"",courseType:""}),S=async t=>{console.log("移动事件："+JSON.stringify(t.event.extendedProps,null,2)),console.log("移动事件id："+t.event.id);const s=a(t.event.start).format("YYYY-MM-DD"),n=Array.isArray(d.events)?d.events.filter(e=>e.extendedProps&&a(e.start).format("YYYY-MM-DD")===s&&t.event.id!=e.id):[];if(n.forEach(e=>{console.log("目标事件："+JSON.stringify(e.extendedProps,null,2)),console.log("目标id"+e.id)}),n.some(e=>{var r,c;return((r=e.extendedProps)==null?void 0:r.courseType)===((c=t.event.extendedProps)==null?void 0:c.courseType)&&a(e.start).isBefore(a(t.event.end))&&a(e.end).isAfter(a(t.event.start))})){y.warning("目标位置已有相同类型的课程且时间段冲突，无法移动"),t.revert();return}p.id=t.event.id,p.dateTime=s,p.beginTime=a(t.event.start).format("HH:mm:ss"),p.endTime=a(t.event.end).format("HH:mm:ss"),(await k(p)).code==200?f():(t.revert(),y.error("更新失败，请重试"))},d=x({plugins:[F,I,B],customButtons:{prevWeekCustom:{text:"上周",click:function(){M()}},nextWeekCustom:{text:"下周",click:function(){A()}},tadayCustom:{text:"本周",click:function(){P()}},prevMonthCustom:{text:"上月",click:function(){N()}},nextMonthCustom:{text:"下月",click:function(){w()}},tbisMonthCustom:{text:"本月",click:function(){Y()}}},headerToolbar:{start:"timeGridWeek,prevWeekCustom,todayCustom,nextWeekCustom",right:"dayGridMonth,prevMonthCustom,thisMonthCustom,nextMonthCustom",center:"title"},buttonText:{today:"今天",month:"月视图",week:"周视图",day:"日",list:"周列表"},contentHeight:window.innerHeight-260,initialView:"timeGridWeek",locale:"zh-cn",weekMode:"liquid",firstDay:1,slotMinTime:"08:00",slotMaxTime:"24:00",slotDuration:"00:15",slotLabelFormat:{hour:"numeric",minute:"2-digit",hour12:!1},eventTimeFormat:{hour:"numeric",minute:"2-digit",hour12:!1},events:[],editable:!0,allDaySlot:!1,nowIndicator:!0,handleWindowResize:!0,navLinks:!0,fixedWeekCount:!0,showNonCurrentDates:!1,selectable:!1,selectMirror:!0,dayMaxEvents:!0,weekends:!0,dateClick:_,eventClick:$,eventDrop:S,eventResize:async t=>{console.log(t);const s=t.event,n={id:s.id,dateTime:a(s.start).format("YYYY-MM-DD"),beginTime:a(s.start).format("HH:mm:ss"),endTime:a(s.end).format("HH:mm:ss"),duration:a(s.end).diff(s.start,"minute")};(await k(n)).code==200?f():(t.revert(),y.error("更新失败，请重试"))}}),H=x({roomIdList:[],courseIdList:[],teacherIdList:[],startDate:"",endDate:"",beginTime:"",endTime:"",duration:0,roomId:"",courseId:"",teacherId:""}),f=async(t={})=>{const s={...H,...t};console.log("发送请求参数:",JSON.stringify(s,null,2));let n=await O(s);if(console.log("接收到响应:",JSON.stringify(n,null,2)),n&&n.code==200){const o=n.data||[];if(console.log("实际数据列表:",o,"数据条数:",o.length),o&&o.length>0){d.events=[];const m={};for(let e=0;e<o.length;e++)if(o[e]){let r={id:"",title:"",start:"",end:"",backgroundColor:"",className:"",extendedProps:{},courseType:""},c=o[e].courseColor,C=o[e].courseColor;r.backgroundColor=c,r.className=C,r.id=o[e].id,r.title=`${o[e].courseName} ${o[e].teacherName} ${o[e].roomName} ${o[e].roomAddress}`,r.start=`${o[e].dateTime} ${o[e].beginTime}`,r.end=`${o[e].dateTime} ${o[e].endTime}`,r.extendedProps=o[e],r.courseType=o[e].courseType;const g=`${o[e].courseType}-${o[e].courseName}`;m[g]||(m[g]=[]),m[g].push(r)}else console.warn(`Item at index ${e} is undefined.`);for(const e in m)m[e].forEach((c,C)=>{c.extendedProps.lessonNumber=C+1,Array.isArray(d.events)?d.events.push(c):console.error("calendarOptions.events is not an array")})}else console.log("没有数据，清空事件数组")}else console.error("API响应错误:",n),d.events=[]},L=t=>{if(!t)return"";const s=["精讲","密训","真题","考点","其他"];for(const n of s){const o=t.indexOf(n);if(o!==-1)return t.substring(o)}return t},W=()=>{f()};return G(()=>{f()}),D({getScheduleList:f}),(t,s)=>(V(),j(U,null,[b(z(J),{ref_key:"fullCalendar",ref:i,class:"demo-app-calendar",options:d},{eventContent:q(n=>[l("div",Q,[l("b",null,u(n.event.extendedProps.dateTime)+" "+u(n.timeText),1),s[0]||(s[0]=l("br",null,null,-1)),l("b",null,"《"+u(n.event.extendedProps.courseName)+"》 "+u(L(n.event.extendedProps.lessonName)),1),s[1]||(s[1]=l("br",null,null,-1)),l("b",null,u(n.event.extendedProps.courseType),1),s[2]||(s[2]=l("br",null,null,-1)),l("b",null,u(n.event.extendedProps.teacherName)+" "+u(n.event.extendedProps.roomName),1)])]),_:1},8,["options"]),b(E,{ref_key:"editRef",ref:v,onUpSuccess:W},null,512)],64))}}),de=K(X,[["__scopeId","data-v-39640a6d"]]);export{de as default};
